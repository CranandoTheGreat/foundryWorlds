(()=>{"use strict";var LOCALIZATION;!function(LOCALIZATION){LOCALIZATION.MIRROR_HORIZONTAL_HOTKEY="fast-flip.mirror-horizontal-hotkey",LOCALIZATION.MIRROR_HORIZONTAL_HINT="fast-flip.mirror-horizontal-hint",LOCALIZATION.MIRROR_HORIZONTAL_BUTTON="fast-flip.mirror-horizontal-button",LOCALIZATION.MIRROR_VERTICAL_HOTKEY="fast-flip.mirror-vertical-hotkey",LOCALIZATION.MIRROR_VERTICAL_HINT="fast-flip.mirror-vertical-hint",LOCALIZATION.MIRROR_VERTICAL_BUTTON="fast-flip.mirror-vertical-button",LOCALIZATION.TOGGLE_AFK_HOTKEY="fast-flip.toggle-afk-hotkey",LOCALIZATION.TOGGLE_AFK_HINT="fast-flip.toggle-afk-hint",LOCALIZATION.TOGGLE_AFK_BUTTON="fast-flip.toggle-afk-button",LOCALIZATION.SHOW_MIRROR_BUTTONS="fast-flip.show-mirror-buttons",LOCALIZATION.SHOW_MIRROR_BUTTONS_HINT="fast-flip.show-mirror-buttons-hint",LOCALIZATION.SHOW_TOGGLE_AFK_BUTTON="fast-flip.show-toggle-afk-button",LOCALIZATION.SHOW_TOGGLE_AFK_HINT="fast-flip.show-toggle-afk-hint",LOCALIZATION.AFK_OVERLAY_ICON_PATH="fast-flip.afk-overlay-icon-path",LOCALIZATION.AFK_OVERLAY_ICON_PATH_HINT="fast-flip.afk-overlay-icon-path-hint",LOCALIZATION.ALLOW_AFK_TOGGLE="fast-flip.allow-afk-toggle",LOCALIZATION.ALLOW_AFK_TOGGLE_HINT="fast-flip.allow-afk-toggle-hint",LOCALIZATION.SHOW_AFK_STATUS_IN_CHAT="fast-flip.show-afk-status-in-chat",LOCALIZATION.SHOW_AFK_STATUS_IN_CHAT_HINT="fast-flip.show-afk-status-in-chat-hint",LOCALIZATION.CHAT_AFK_MESSAGE="fast-flip.chat-afk-message",LOCALIZATION.CHAT_RETURNED_MESSAGE="fast-flip.chat-returned-message",LOCALIZATION.SHOW_SPEECH_BUBBLE_HOTKEY="fast-flip.show-speech-bubble-hotkey",LOCALIZATION.SHOW_SPEECH_BUBBLE_HINT="fast-flip.show-speech-bubble-hint",LOCALIZATION.ALLOW_SPEECH_BUBBLES="fast-flip.allow-speech-bubbles",LOCALIZATION.ALLOW_SPEECH_BUBBLES_HINT="fast-flip.allow-speech-bubbles-hint",LOCALIZATION.SPEECH_BUBBLE_FONT_SIZE="fast-flip.speech-bubble-font-size",LOCALIZATION.SPEECH_BUBBLE_FONT_SIZE_HINT="fast-flip.speech-bubble-font-size-hint",LOCALIZATION.ANIMATION_DURATION="fast-flip.animation-duration",LOCALIZATION.ANIMATION_DURATION_HINT="fast-flip.animation-duration-hint"}(LOCALIZATION||(LOCALIZATION={}));var _TokenManager_instances,_TokenManager_game,_TokenManager_settings,_TokenManager_animatingTokens,_TokenManager_markToken,_TokenManager_controlledTokens_get,_TokenManager_onUpdateToken,__classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},__classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class TokenManager{constructor(game,settings){_TokenManager_instances.add(this),_TokenManager_game.set(this,void 0),_TokenManager_settings.set(this,void 0),_TokenManager_animatingTokens.set(this,new Set),__classPrivateFieldSet(this,_TokenManager_game,game,"f"),__classPrivateFieldSet(this,_TokenManager_settings,settings,"f"),Hooks.on("updateToken",__classPrivateFieldGet(this,_TokenManager_instances,"m",_TokenManager_onUpdateToken).bind(this))}async mirrorSelected(tokenMirrorDirection){for(const token of __classPrivateFieldGet(this,_TokenManager_instances,"a",_TokenManager_controlledTokens_get)){if(!token.isOwner)continue;if(__classPrivateFieldGet(this,_TokenManager_instances,"m",_TokenManager_markToken).call(this,token.id))continue;const flipMirror=-token.document.texture[tokenMirrorDirection],animationDuration=__classPrivateFieldGet(this,_TokenManager_settings,"f").animationDuration;await token.document.update({[`texture.${tokenMirrorDirection}`]:flipMirror},{animate:0!==animationDuration,animation:{duration:animationDuration}})}}async toggleAFK(){var _a;if(__classPrivateFieldGet(this,_TokenManager_settings,"f").allowAFKToggle)for(const token of __classPrivateFieldGet(this,_TokenManager_instances,"a",_TokenManager_controlledTokens_get)){if(!token.isOwner||!(null===(_a=token.actor)||void 0===_a?void 0:_a.hasPlayerOwner))continue;const isAFK=token.document.getFlag("fast-flip","afk-state"),afkIconPath=__classPrivateFieldGet(this,_TokenManager_settings,"f").afkOverlayIconPath;if(isAFK){const previousOverlayEffect=token.document.getFlag("fast-flip","previous-overlay-effect");await token.document.unsetFlag("fast-flip","previous-overlay-effect"),await token.document.setFlag("fast-flip","afk-state",!1),await token.document.update({overlayEffect:null!=previousOverlayEffect?previousOverlayEffect:null}),__classPrivateFieldGet(this,_TokenManager_settings,"f").showAFKStatusInChat&&ChatMessage.create({type:CONST.CHAT_MESSAGE_TYPES.OOC,speaker:{token:token.id},content:__classPrivateFieldGet(this,_TokenManager_game,"f").i18n.format(LOCALIZATION.CHAT_RETURNED_MESSAGE,{name:token.name})})}else{const previousOverlayEffect=token.document.overlayEffect;await token.document.setFlag("fast-flip","previous-overlay-effect",previousOverlayEffect),await token.document.setFlag("fast-flip","afk-state",!0),await token.document.update({overlayEffect:afkIconPath}),__classPrivateFieldGet(this,_TokenManager_settings,"f").showAFKStatusInChat&&ChatMessage.create({type:CONST.CHAT_MESSAGE_TYPES.OOC,speaker:{token:token.id},content:__classPrivateFieldGet(this,_TokenManager_game,"f").i18n.format(LOCALIZATION.CHAT_AFK_MESSAGE,{name:token.name})})}}}}_TokenManager_game=new WeakMap,_TokenManager_settings=new WeakMap,_TokenManager_animatingTokens=new WeakMap,_TokenManager_instances=new WeakSet,_TokenManager_markToken=function(id){return!!__classPrivateFieldGet(this,_TokenManager_animatingTokens,"f").has(id)||(__classPrivateFieldGet(this,_TokenManager_animatingTokens,"f").add(id),setTimeout((()=>{__classPrivateFieldGet(this,_TokenManager_animatingTokens,"f").delete(id)}),__classPrivateFieldGet(this,_TokenManager_settings,"f").animationDuration),!1)},_TokenManager_controlledTokens_get=function(){var _a,_b;return null!==(_b=null===(_a=__classPrivateFieldGet(this,_TokenManager_game,"f").canvas.tokens)||void 0===_a?void 0:_a.controlled)&&void 0!==_b?_b:[]},_TokenManager_onUpdateToken=async function(_,update){if(update._id&&void 0!==update.overlayEffect){const token=__classPrivateFieldGet(this,_TokenManager_game,"f").canvas.tokens.get(update._id);token&&await token.drawEffects()}};var _TileManager_instances,_TileManager_game,_TileManager_onCanvasReady,_TileManager_onUpdateTile,_TileManager_updateTileOrientation,_TileManager_allTiles_get,_TileManager_controlledTiles_get,_TileManager_findTile,TileManager_classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},TileManager_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class TileManager{constructor(game){_TileManager_instances.add(this),_TileManager_game.set(this,void 0),TileManager_classPrivateFieldSet(this,_TileManager_game,game,"f"),Hooks.on("updateTile",TileManager_classPrivateFieldGet(this,_TileManager_instances,"m",_TileManager_onUpdateTile).bind(this)),Hooks.on("canvasReady",TileManager_classPrivateFieldGet(this,_TileManager_instances,"m",_TileManager_onCanvasReady).bind(this))}async mirrorSelectedTiles(tileMirrorDirection){for(const tile of TileManager_classPrivateFieldGet(this,_TileManager_instances,"a",_TileManager_controlledTiles_get)){const previousState=tile.document.getFlag("fast-flip",tileMirrorDirection);await tile.document.setFlag("fast-flip",tileMirrorDirection,!previousState)}}}function getIcon(icon){return`modules/fast-flip/icons/${icon}.svg`}_TileManager_game=new WeakMap,_TileManager_instances=new WeakSet,_TileManager_onCanvasReady=function(){for(const tile of TileManager_classPrivateFieldGet(this,_TileManager_instances,"a",_TileManager_allTiles_get))TileManager_classPrivateFieldGet(this,_TileManager_instances,"m",_TileManager_updateTileOrientation).call(this,tile)},_TileManager_onUpdateTile=function(_,update){var _a;if(update._id&&(null===(_a=update.flags)||void 0===_a?void 0:_a["fast-flip"])){const tile=TileManager_classPrivateFieldGet(this,_TileManager_instances,"m",_TileManager_findTile).call(this,update._id);tile&&TileManager_classPrivateFieldGet(this,_TileManager_instances,"m",_TileManager_updateTileOrientation).call(this,tile)}},_TileManager_updateTileOrientation=function(tile){if(tile.texture){const flipHorizontal=tile.document.getFlag("fast-flip","tileMirrorHorizontal"),flipVerical=tile.document.getFlag("fast-flip","tileMirrorVertical"),mirrorHorizontal=flipHorizontal?PIXI.groupD8.MIRROR_HORIZONTAL:0,mirrorVertical=flipVerical?PIXI.groupD8.MIRROR_VERTICAL:0,rotate=PIXI.groupD8.add(mirrorHorizontal,mirrorVertical);tile.texture.rotate=rotate,tile.refresh()}},_TileManager_allTiles_get=function(){var _a;return null!==(_a=TileManager_classPrivateFieldGet(this,_TileManager_game,"f").canvas.tiles.tiles)&&void 0!==_a?_a:[]},_TileManager_controlledTiles_get=function(){var _a;return null!==(_a=TileManager_classPrivateFieldGet(this,_TileManager_game,"f").canvas.tiles.controlled)&&void 0!==_a?_a:[]},_TileManager_findTile=function(id){return TileManager_classPrivateFieldGet(this,_TileManager_game,"f").canvas.tiles.get(id)};var _Settings_instances,_Settings_game,_Settings_registerSettings,SETTING,Settings_classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},Settings_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};!function(SETTING){SETTING.ANIMATION_DURATION="animation-duration",SETTING.ALLOW_AFK_TOGGLE="allow-afk-toggle",SETTING.SHOW_AFK_STATUS_IN_CHAT="show-afk-status-in-chat",SETTING.SHOW_MIRROR_BUTTONS_ON_HUD="show-mirror-buttons-hud",SETTING.SHOW_TOGGLE_AFK_BUTTON_ON_HUD="show-toggle-afk-hud",SETTING.AFK_OVERLAY_ICON_PATH="afk-overlay-icon-path",SETTING.ALLOW_SPEECH_BUBBLES="allow-speech-bubbles",SETTING.SPEECH_BUBBLE_FONT_SIZE="speech-bubble-font-size"}(SETTING||(SETTING={}));class Settings{constructor(game){_Settings_instances.add(this),_Settings_game.set(this,void 0),Settings_classPrivateFieldSet(this,_Settings_game,game,"f"),Settings_classPrivateFieldGet(this,_Settings_instances,"m",_Settings_registerSettings).call(this)}get animationDuration(){return 1e3*Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.ANIMATION_DURATION)}get afkOverlayIconPath(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.AFK_OVERLAY_ICON_PATH)}get showMirrorButtons(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.SHOW_MIRROR_BUTTONS_ON_HUD)}get allowAFKToggle(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.ALLOW_AFK_TOGGLE)}get showAFKStatusInChat(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.SHOW_AFK_STATUS_IN_CHAT)}get showToggleAFKButton(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.SHOW_TOGGLE_AFK_BUTTON_ON_HUD)}get allowSpeechBubbles(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.ALLOW_SPEECH_BUBBLES)}get speechBubbleFontSize(){return Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.get("fast-flip",SETTING.SPEECH_BUBBLE_FONT_SIZE)}}_Settings_game=new WeakMap,_Settings_instances=new WeakSet,_Settings_registerSettings=function(){const settings={[SETTING.ANIMATION_DURATION]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ANIMATION_DURATION),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ANIMATION_DURATION_HINT),scope:"world",config:!0,default:.1,type:Number,range:{min:0,max:1,step:.1}},[SETTING.ALLOW_SPEECH_BUBBLES]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ALLOW_SPEECH_BUBBLES),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ALLOW_SPEECH_BUBBLES_HINT),scope:"world",config:!0,default:!0,type:Boolean},[SETTING.SPEECH_BUBBLE_FONT_SIZE]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SPEECH_BUBBLE_FONT_SIZE),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SPEECH_BUBBLE_FONT_SIZE_HINT),scope:"client",config:!0,default:14,type:Number,range:{min:14,max:42,step:1}},[SETTING.AFK_OVERLAY_ICON_PATH]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.AFK_OVERLAY_ICON_PATH),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.AFK_OVERLAY_ICON_PATH_HINT),scope:"world",config:!0,default:getIcon("afk"),filePicker:"imagevideo"},[SETTING.ALLOW_AFK_TOGGLE]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ALLOW_AFK_TOGGLE),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.ALLOW_AFK_TOGGLE_HINT),scope:"world",config:!0,default:!0,type:Boolean},[SETTING.SHOW_AFK_STATUS_IN_CHAT]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_AFK_STATUS_IN_CHAT),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_AFK_STATUS_IN_CHAT_HINT),scope:"world",config:!0,default:!0,type:Boolean},[SETTING.SHOW_MIRROR_BUTTONS_ON_HUD]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_MIRROR_BUTTONS),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_MIRROR_BUTTONS_HINT),scope:"client",config:!0,default:!0,type:Boolean},[SETTING.SHOW_TOGGLE_AFK_BUTTON_ON_HUD]:{name:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_TOGGLE_AFK_BUTTON),hint:Settings_classPrivateFieldGet(this,_Settings_game,"f").i18n.localize(LOCALIZATION.SHOW_TOGGLE_AFK_HINT),scope:"client",config:!0,default:!0,type:Boolean}};for(const[name,value]of Object.entries(settings))Settings_classPrivateFieldGet(this,_Settings_game,"f").settings.register("fast-flip",name,value)};var _HUD_instances,_HUD_game,_HUD_buttons,_HUD_render,hud_classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},hud_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class HUD{constructor(game,name){_HUD_instances.add(this),_HUD_game.set(this,void 0),_HUD_buttons.set(this,void 0),hud_classPrivateFieldSet(this,_HUD_game,game,"f"),hud_classPrivateFieldSet(this,_HUD_buttons,new Map,"f"),Hooks.on(`render${name}`,hud_classPrivateFieldGet(this,_HUD_instances,"m",_HUD_render).bind(this))}registerButton(id,props){hud_classPrivateFieldGet(this,_HUD_buttons,"f").set(id,props)}}_HUD_game=new WeakMap,_HUD_buttons=new WeakMap,_HUD_instances=new WeakSet,_HUD_render=function(hud,html){var _a,_b;for(const[_,props]of hud_classPrivateFieldGet(this,_HUD_buttons,"f")){if(null===(_b=null===(_a=props.shouldShow)||void 0===_a?void 0:_a.call(props,hud.object))||void 0===_b||_b){const title=hud_classPrivateFieldGet(this,_HUD_game,"f").i18n.localize(props.title),button=document.createElement("div");button.classList.add("control-icon"),button.onclick=()=>props.onClick(hud.object),button.title=title;const img=document.createElement("img");img.title=title,img.alt=title,img.src=props.icon,img.width=36,img.height=36,button.appendChild(img),html.find(`div.${props.side}`).append(button)}}};var _SpeechBubbles_instances,_SpeechBubbles_template,_SpeechBubbles_settings,_SpeechBubbles_keyboard,_SpeechBubbles_keybindings,_SpeechBubbles_keyClearInterval,_SpeechBubbles_renderHTML,_SpeechBubbles_getMessageDimensions,_SpeechBubbles_setPosition,SpeechBubbles_classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},SpeechBubbles_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class SpeechBubbles{constructor(settings,keyboard,keybindings){_SpeechBubbles_instances.add(this),_SpeechBubbles_template.set(this,void 0),_SpeechBubbles_settings.set(this,void 0),_SpeechBubbles_keyboard.set(this,void 0),_SpeechBubbles_keybindings.set(this,void 0),_SpeechBubbles_keyClearInterval.set(this,void 0),SpeechBubbles_classPrivateFieldSet(this,_SpeechBubbles_settings,settings,"f"),SpeechBubbles_classPrivateFieldSet(this,_SpeechBubbles_keyboard,keyboard,"f"),SpeechBubbles_classPrivateFieldSet(this,_SpeechBubbles_keybindings,keybindings,"f"),SpeechBubbles_classPrivateFieldSet(this,_SpeechBubbles_template,"templates/hud/chat-bubble.html","f")}get container(){return $("#chat-bubbles")}async show(token){const html=$(await SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_instances,"m",_SpeechBubbles_renderHTML).call(this,{token,message:token.name})),dimensions=SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_instances,"m",_SpeechBubbles_getMessageDimensions).call(this,token.name);return SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_instances,"m",_SpeechBubbles_setPosition).call(this,token,html,dimensions),this.container.append(html),SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_keyClearInterval,"f")||clearInterval(SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_keyClearInterval,"f")),SpeechBubbles_classPrivateFieldSet(this,_SpeechBubbles_keyClearInterval,setInterval((()=>{var _a,_b,_c;const[bindings]=null!==(_b=null===(_a=SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_keybindings,"f").bindings)||void 0===_a?void 0:_a.get(`fast-flip.${LOCALIZATION.SHOW_SPEECH_BUBBLE_HOTKEY}`))&&void 0!==_b?_b:[],keys=bindings?[bindings.key,...null!==(_c=bindings.modifiers)&&void 0!==_c?_c:[]]:[],keySet=new Set(keys),downKeys=function(keys){const normalizedKeys=new Set;for(const key of keys)KeyboardManager.MODIFIER_CODES.Alt.indexOf(key)>=0?normalizedKeys.add(KeyboardManager.MODIFIER_KEYS.ALT):KeyboardManager.MODIFIER_CODES.Control.indexOf(key)>=0?normalizedKeys.add(KeyboardManager.MODIFIER_KEYS.CONTROL):KeyboardManager.MODIFIER_CODES.Shift.indexOf(key)>=0?normalizedKeys.add(KeyboardManager.MODIFIER_KEYS.SHIFT):normalizedKeys.add(key);return normalizedKeys}(SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_keyboard,"f").downKeys);keySet.isSubset(downKeys)||this.hide(token)}),250),"f"),await new Promise((resolve=>html.fadeIn(250,(()=>{resolve()}))))}hide(token){const existing=$(`.chat-bubble[data-token-id="${token.id}"]`);if(existing.length)return new Promise((resolve=>{clearInterval(SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_keyClearInterval,"f")),existing.fadeOut(100,(()=>{existing.remove(),resolve()}))}))}}_SpeechBubbles_template=new WeakMap,_SpeechBubbles_settings=new WeakMap,_SpeechBubbles_keyboard=new WeakMap,_SpeechBubbles_keybindings=new WeakMap,_SpeechBubbles_keyClearInterval=new WeakMap,_SpeechBubbles_instances=new WeakSet,_SpeechBubbles_renderHTML=async function(data){return renderTemplate(SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_template,"f"),data)},_SpeechBubbles_getMessageDimensions=function(message){const div=$(`<div class="chat-bubble" style="visibility:hidden; font-size: ${SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_settings,"f").speechBubbleFontSize}px">${message}</div>`);$("body").append(div);const dims={width:div[0].clientWidth+8,height:div[0].clientHeight,unconstrained:void 0};return div.css({maxHeight:"none"}),dims.unconstrained=div[0].clientHeight,div.remove(),dims},_SpeechBubbles_setPosition=function(token,html,dimensions){html.addClass("right"),html.css("font-size",`${SpeechBubbles_classPrivateFieldGet(this,_SpeechBubbles_settings,"f").speechBubbleFontSize}px`);const position={height:dimensions.height,width:dimensions.width,top:token.y-dimensions.height-8,left:token.x-(dimensions.width-token.w)};html.css(position)};var _SpeechManager_instances,_SpeechManager_game,_SpeechManager_settings,_SpeechManager_speechBubbles,_SpeechManager_onCanvasReady,_SpeechManager_onSocketMessage,SpeechManager_classPrivateFieldSet=function(receiver,state,value,kind,f){if("m"===kind)throw new TypeError("Private method is not writable");if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===kind?f.call(receiver,value):f?f.value=value:state.set(receiver,value),value},SpeechManager_classPrivateFieldGet=function(receiver,state,kind,f){if("a"===kind&&!f)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof state?receiver!==state||!f:!state.has(receiver))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===kind?f:"a"===kind?f.call(receiver):f?f.value:state.get(receiver)};class SpeechManager{constructor(game,settings){var _a;_SpeechManager_instances.add(this),_SpeechManager_game.set(this,void 0),_SpeechManager_settings.set(this,void 0),_SpeechManager_speechBubbles.set(this,void 0),SpeechManager_classPrivateFieldSet(this,_SpeechManager_game,game,"f"),SpeechManager_classPrivateFieldSet(this,_SpeechManager_settings,settings,"f"),Hooks.on("canvasReady",SpeechManager_classPrivateFieldGet(this,_SpeechManager_instances,"m",_SpeechManager_onCanvasReady).bind(this)),null===(_a=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").socket)||void 0===_a||_a.on("module.fast-flip",SpeechManager_classPrivateFieldGet(this,_SpeechManager_instances,"m",_SpeechManager_onSocketMessage).bind(this))}async showSpeechBubble(){var _a,_b,_c,_d,_e,_f;if(!SpeechManager_classPrivateFieldGet(this,_SpeechManager_settings,"f").allowSpeechBubbles)return;const token=null===(_c=null===(_b=null===(_a=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas)||void 0===_a?void 0:_a.tokens)||void 0===_b?void 0:_b.controlled)||void 0===_c?void 0:_c[0];if(!(null==token?void 0:token.isOwner))return;const sceneID=null===(_d=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas.scene)||void 0===_d?void 0:_d.id,tokenID=null==token?void 0:token.id;tokenID&&sceneID&&(await(null===(_e=SpeechManager_classPrivateFieldGet(this,_SpeechManager_speechBubbles,"f"))||void 0===_e?void 0:_e.show(token)),null===(_f=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").socket)||void 0===_f||_f.emit("module.fast-flip",{type:0,tokenID,sceneID}))}hideSpeechBubble(){var _a,_b,_c,_d,_e,_f;const sceneID=null===(_a=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas.scene)||void 0===_a?void 0:_a.id,token=null===(_d=null===(_c=null===(_b=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas)||void 0===_b?void 0:_b.tokens)||void 0===_c?void 0:_c.controlled)||void 0===_d?void 0:_d[0];(null==token?void 0:token.isOwner)&&sceneID&&(null===(_e=SpeechManager_classPrivateFieldGet(this,_SpeechManager_speechBubbles,"f"))||void 0===_e||_e.hide(token),null===(_f=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").socket)||void 0===_f||_f.emit("module.fast-flip",{type:1,sceneID,tokenID:token.id}))}}_SpeechManager_game=new WeakMap,_SpeechManager_settings=new WeakMap,_SpeechManager_speechBubbles=new WeakMap,_SpeechManager_instances=new WeakSet,_SpeechManager_onCanvasReady=function(){SpeechManager_classPrivateFieldSet(this,_SpeechManager_speechBubbles,new SpeechBubbles(SpeechManager_classPrivateFieldGet(this,_SpeechManager_settings,"f"),SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").keyboard,SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").keybindings),"f")},_SpeechManager_onSocketMessage=async function(data){var _a,_b,_c,_d,_e,_f,_g,_h;if(SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas)switch(data.type){case 0:{if((null===(_a=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas.scene)||void 0===_a?void 0:_a.id)!==data.sceneID)return;const token=null===(_c=null===(_b=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas)||void 0===_b?void 0:_b.tokens)||void 0===_c?void 0:_c.get(data.tokenID);if(!token)return;return void await(null===(_d=SpeechManager_classPrivateFieldGet(this,_SpeechManager_speechBubbles,"f"))||void 0===_d?void 0:_d.show(token))}case 1:{if((null===(_e=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas.scene)||void 0===_e?void 0:_e.id)!==data.sceneID)return;const token=null===(_g=null===(_f=SpeechManager_classPrivateFieldGet(this,_SpeechManager_game,"f").canvas)||void 0===_f?void 0:_f.tokens)||void 0===_g?void 0:_g.get(data.tokenID);if(!token)return;return void(null===(_h=SpeechManager_classPrivateFieldGet(this,_SpeechManager_speechBubbles,"f"))||void 0===_h||_h.hide(token))}}},Hooks.once("init",(()=>{if(game instanceof Game){const settings=new Settings(game),tokenHUD=new HUD(game,"TokenHUD"),tokenManager=new TokenManager(game,settings),tileHUD=new HUD(game,"TileHUD"),tileManager=new TileManager(game),speechManager=new SpeechManager(game,settings);!function(game,tokenManager,tileManager,speechManager){const horizontalFlip=async()=>{await tokenManager.mirrorSelected("scaleX"),await tileManager.mirrorSelectedTiles("tileMirrorHorizontal")};game.keybindings.register("fast-flip","horizontalFlip",{name:LOCALIZATION.MIRROR_HORIZONTAL_HOTKEY,hint:game.i18n.localize(LOCALIZATION.MIRROR_HORIZONTAL_HINT),editable:[{key:"KeyF"}],onDown:horizontalFlip,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL,restricted:!1,reservedModifiers:[],repeat:!1});const verticalFlip=async()=>{await tokenManager.mirrorSelected("scaleY"),await tileManager.mirrorSelectedTiles("tileMirrorVertical")};game.keybindings.register("fast-flip","verticalFlip",{name:LOCALIZATION.MIRROR_VERTICAL_HOTKEY,hint:game.i18n.localize(LOCALIZATION.MIRROR_VERTICAL_HINT),editable:[{key:"KeyF",modifiers:["SHIFT"]}],onDown:verticalFlip,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL,restricted:!1,reservedModifiers:[],repeat:!1});const toggleAFK=async()=>await tokenManager.toggleAFK();game.keybindings.register("fast-flip",LOCALIZATION.TOGGLE_AFK_HOTKEY,{name:LOCALIZATION.TOGGLE_AFK_HOTKEY,hint:game.i18n.localize(LOCALIZATION.TOGGLE_AFK_HINT),editable:[{key:"KeyK",modifiers:["SHIFT"]}],onDown:toggleAFK,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL,restricted:!1,reservedModifiers:[],repeat:!1});const onStartSpeaking=async()=>{await speechManager.showSpeechBubble()},onStopSpeaking=()=>{speechManager.hideSpeechBubble()};game.keybindings.register("fast-flip",LOCALIZATION.SHOW_SPEECH_BUBBLE_HOTKEY,{name:LOCALIZATION.SHOW_SPEECH_BUBBLE_HOTKEY,hint:game.i18n.localize(LOCALIZATION.SHOW_SPEECH_BUBBLE_HINT),editable:[{key:"KeyS",modifiers:["ALT"]}],onDown:onStartSpeaking,onUp:onStopSpeaking,precedence:CONST.KEYBINDING_PRECEDENCE.NORMAL,restricted:!1,reservedModifiers:[],repeat:!1})}(game,tokenManager,tileManager,speechManager),function(settings,tokenHUD,tileHUD,tokenManager,tileManager){const mirrorHorizontalIcon=getIcon("mirror-horizontal"),mirrorVerticalIcon=getIcon("mirror-vertical"),toggleAFKIcon=getIcon("toggle-afk");tokenHUD.registerButton("fast-flip.mirror-horizontal",{side:"left",title:LOCALIZATION.MIRROR_HORIZONTAL_BUTTON,icon:mirrorHorizontalIcon,onClick:()=>{tokenManager.mirrorSelected("scaleX")},shouldShow:token=>settings.showMirrorButtons&&token.isOwner}),tokenHUD.registerButton("fast-flip.mirror-vertical",{side:"left",title:LOCALIZATION.MIRROR_VERTICAL_BUTTON,icon:mirrorVerticalIcon,onClick:()=>{tokenManager.mirrorSelected("scaleY")},shouldShow:token=>settings.showMirrorButtons&&token.isOwner}),tokenHUD.registerButton("fast-flip.toggle-afk",{side:"right",title:LOCALIZATION.TOGGLE_AFK_BUTTON,icon:toggleAFKIcon,onClick:()=>{tokenManager.toggleAFK()},shouldShow:token=>{var _a,_b;return settings.allowAFKToggle&&settings.showToggleAFKButton&&token.isOwner&&null!==(_b=null===(_a=token.actor)||void 0===_a?void 0:_a.hasPlayerOwner)&&void 0!==_b&&_b}}),tileHUD.registerButton("fast-flip.mirror-horizontal",{side:"left",title:LOCALIZATION.MIRROR_HORIZONTAL_BUTTON,icon:mirrorHorizontalIcon,onClick:()=>{tileManager.mirrorSelectedTiles("tileMirrorHorizontal")}}),tileHUD.registerButton("fast-flip.mirror-vertical",{side:"left",title:LOCALIZATION.MIRROR_VERTICAL_BUTTON,icon:mirrorVerticalIcon,onClick:()=>{tileManager.mirrorSelectedTiles("tileMirrorVertical")}})}(settings,tokenHUD,tileHUD,tokenManager,tileManager)}}))})();